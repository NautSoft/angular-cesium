/*
 * angular-cesiumjs
 * http://maikuru.github.io/angular-cesiumjs

 * Version: 0.2.1 - 2014-12-08
 * License: Apache-2.0
 */
angular.module("cesiumjs",["cesiumjs.tpls","cesiumjs.widget"]),angular.module("cesiumjs",["cesiumjs.widget"]).constant("IMAGERY_PROVIDER",{BING:{label:"bing",customLabel:"bing",url:"http://dev.virtualearth.net",ellipsoid:Cesium.Ellipsoid.WGS84,apiKey:null,active:!0,online:!0},BLACK_MARBLE:{label:"blackMarble",url:"http://dev.virtualearth.net",ellipsoid:Cesium.Ellipsoid.WGS84,maximumLevel:8},NATURAL_EARTH_II:{label:"naturalEarthII",url:"bower_components/cesiumjs/Build/Cesium/Assets/Textures/NaturalEarthII",ellipsoid:Cesium.Ellipsoid.WGS84},WEB_MAP_SERVICE:{label:"WebMapService",url:"http://localhost:8080/geoserver/example/wms",layers:"",ellipsoid:Cesium.Ellipsoid.WGS84},SINGLE_TILE:{label:"SingleTile",url:"/path/to/file",credit:""},TILE_MAP_SERVICE:{label:"TileMapService",url:"/path/to/files/onServer",credit:"",fileExtension:"png",minimumLevel:0,maximumLevel:13,ellipsoid:Cesium.Ellipsoid.WGS84,tilingScheme:Cesium.GeographicTilingScheme,tileWidth:256,tileHeight:256}}).constant("SCENE_MODE",{scene2d:Cesium.SceneMode.SCENE2D,scene3d:Cesium.SceneMode.SCENE3D,sceneColumbus:Cesium.SceneMode.COLUMBUS_VIEW}).constant("PIN_COLLECTION_MAKI",{camera:"camera"}),angular.module("cesiumjs.tpls",[]),angular.module("cesiumjs.widget",["angular-md5"]).controller("WidgetController",["$scope","$attrs","$parse","$log","CesiumjsWidgetService",function(a,b,c,d,e){this.init=function(a){d.debug("WidgetController: init"),this.$element=a;var c=this.$element[0].id,f={scene3DOnly:"true"===b.scene3dOnly.toLowerCase()||"1"===b.scene3dOnly};("true"===b.noDefaultImagery.toLowerCase()||"1"===b.noDefaultImagery)&&(f.imageryProvider=!1),e.initViewer(c,f)}}]).service("CesiumjsWidgetService",["$q","$log","md5","IMAGERY_PROVIDER","PIN_COLLECTION_MAKI",function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r=a.defer(),s=[r.promise],t=this,u=Cesium.Math;this.animationMethod=null,this.initViewer=function(a,c){b.debug("CesiumjsWidgetService: initViewer started"),!angular.isDefined(f)||f.isDestroyed()?(b.debug("CesiumjsWidgetService: initViewer creating widget"),c.showRenderLoopErrors=!0,c.targetFrameRate=60,f=new Cesium.CesiumWidget(a,c),f.resolutionScale=2,g=f.scene,h=f.clock,j=g.camera,i=g.primitives,i.globe=new Cesium.Globe(Cesium.Ellipsoid.WGS84),p=p||{},o=i.add(new Cesium.PolylineCollection),l=i.add(new Cesium.BillboardCollection),k=new Cesium.PinBuilder,i.globe=new Cesium.Globe(Cesium.Ellipsoid.WGS84),g.sun=new Cesium.Sun,g.moon=new Cesium.Moon,g.skyAtmosphere=new Cesium.SkyAtmosphere,g.skyBox=this.generateSkyBox()):angular.isDefined(f)&&b.warn("CesiumjsWidgetService: initViewer already exists"),r.resolve(function(){b.debug("CesiumjsWidgetService: init Viewer success")})},this.addCustomMarker=function(a,d,e,f,g,h,i){this.whenReady(function(){b.debug("CesiumjsWidgetService: addCustomMarker "+d+" ["+f+","+g+"]");var j=c.createHash(a);n=n||{},e=angular.isNumber(e)&&e>5?e:128,n[j]=l.add({image:d,verticalOrigin:Cesium.VerticalOrigin.CENTER,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,position:Cesium.Cartesian3.fromDegrees(g,f,h),show:!!i})})},this.addImageryLayer=function(a,b){this.whenReady(function(){p[a]=g.imageryLayers.addImageryProvider(b)})},this.addMarker=function(d,f,g,h,i,j,n){a.all(s).then(function(){b.debug("CesiumjsWidgetService: addMarker "+f+" ["+i+","+j+"]"),m=m||{},angular.isDefined(e[f])||b.error("CesiumjsWidgetService: addMarker - invalid marker type = "+f),h=angular.isNumber(h)&&h>5?h:48;var a=Cesium.Color.fromCssColorString(g),o=c.createHash(d);Cesium.when(k.fromMakiIconId(f,a,h),function(a){b.debug("CesiumjsWidgetService: addMarker canvas created"),m[o]=l.add({image:a,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,position:Cesium.Cartesian3.fromDegrees(j,i,0),show:!!n})})})},this.addPolyLine=function(c,d,e,f){a.all(s).then(function(){b.debug("CesiumjsWidgetService: addPolyLine"),q=q||{},f&&o.removeAll(),q[c]=o.add({positions:Cesium.Cartesian3.fromDegreesArrayHeights(d),width:2,material:Cesium.Material.fromType("Color",{color:Cesium.Color.fromCssColorString(e)})})})},this.adjustCamera=function(b,c){a.all(s).then(function(){var a=u.toRadians(c);switch(b){case"roll":case"twistRight":j.twistRight(a);break;case"lookUp":case"tilt":j.lookUp(a);break;default:angular.isFunction(j[b])&&j[b](a)}})},this._adjustCamera=function(a,b){if(angular.isDefined(j)){var c=u.toRadians(b);switch(a){case"roll":case"twistRight":j.twistRight(c);break;case"lookUp":case"tilt":j.lookUp(c);break;default:angular.isFunction(j[a])&&j[a](c)}}},this.adjustClock=function(c){a.all(s).then(function(){b.debug("CesiumjsWidgetService: adjusting Clock"),b.debug(c),c=angular.isObject(c)?c:{},angular.isDate(c.startTime)&&(h.startTime=Cesium.JulianDate.fromDate(c.startTime)),angular.isDate(c.currentTime)&&(h.currentTime=Cesium.JulianDate.fromDate(c.currentTime)),angular.isDate(c.stopTime)&&(h.stopTime=Cesium.JulianDate.fromDate(c.stopTime)),angular.isNumber(c.multiplier)&&(h.multiplier=c.multiplier),angular.isDefined(Cesium.ClockStep[c.clockStep])&&(h.clockStep=c.clockStep),angular.isDefined(Cesium.ClockRange[c.clockRange])&&(h.clockRange=clockRange)})},this.enableDebug=function(c){a.all(s).then(function(){b.debug("CesiumjsWidgetService: enableDebug "+c),g.debugShowFramesPerSecond=!!c})},this.enableDefaultHandlers=function(c){a.all(s).then(function(){b.debug("CesiumjsWidgetService: enableDefaultHandlers "+c),c=!!c,g.screenSpaceCameraController.enableLook=c,g.screenSpaceCameraController.enableTilt=c,g.screenSpaceCameraController.enableZoom=c,g.screenSpaceCameraController.enableRotate=c,g.screenSpaceCameraController.enableTranslate=c})},this.enableMoon=function(c){a.all(s).then(function(){b.debug("CesiumjsWidgetService: enableMoon "+c),f.scene.moon.show=!!c})},this.enableSkyAtmosphere=function(c){a.all(s).then(function(){b.debug("CesiumjsWidgetService: enableAtmosphere "+c),g.skyAtmosphere.show=!!c})},this.enableSkyBox=function(a){this.whenReady(function(){b.debug("CesiumjsWidgetService: enableSkyBox "+a),g.skyAtmosphere.show=!!a})},this.enableSun=function(c){a.all(s).then(function(){b.debug("CesiumjsWidgetService: enableSun "+c),g.sun.show=!!c})},this.generateImageryProvider=function(a){b.debug("CesiumjsWidgetService: generateImageryProvider "+a.label),b.debug(a);var c;switch(a.label){case d.BING.label:var e=a.apiKey||Cesium.BingMapsApi.defaultKey;Cesium.BingMapsApi.defaultKey=e,c=new Cesium.BingMapsImageryProvider({url:a.url,key:e,mapStyle:Cesium.BingMapsStyle.AERIAL});break;case d.BLACK_MARBLE.label:c=new Cesium.TileMapServiceImageryProvider({url:a.url,maximumLevel:a.maximumLevel});break;case d.NATURAL_EARTH_II.label:c=new Cesium.TileMapServiceImageryProvider({url:a.url});break;case d.WEB_MAP_SERVICE.label:c=new Cesium.WebMapServiceImageryProvider({url:a.url,layers:a.layers,maximumLevel:a.maximumLevel,minimumLevel:a.minimumLevel,parameters:a.parameters});break;case d.SINGLE_TILE.label:c=new Cesium.SingleTileImageryProvider({url:a.url});break;case d.TILE_MAP_SERVICE.label:c=new Cesium.TileMapServiceImageryProvider(a);break;default:return b.error("no supported image provider:"+a.label),null}return c},this.generateSkyBox=function(){var a="bower_components/cesiumjs/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80";return Cesium.SkyBox({show:!1,sources:{positiveX:a+"_px.jpg",negativeX:a+"_mx.jpg",positiveY:a+"_py.jpg",negativeY:a+"_my.jpg",positiveZ:a+"_pz.jpg",negativeZ:a+"_mz.jpg"}})},this.getCurrentTime=function(){var b=a.defer();return a.all(s).then(function(){b.resolve(Cesium.JulianDate.toDate(h.currentTime))},function(a){b.reject(a)},function(a){b.update(a)}),b.promise},this.hideAllCustomMarkers=function(){a.all(s).then(function(){b.debug("CesiumjsWidgetService: hideAllMarkers "),n=n||{},angular.forEach(n,function(a){a.show=!1})})},this.hideAllMarkers=function(){a.all(s).then(function(){b.debug("CesiumjsWidgetService: hideAllMarkers "),m=m||{},angular.forEach(m,function(a){a.show=!1})})},this.hideCustomMarker=function(d){a.all(s).then(function(){b.debug("CesiumjsWidgetService: hideCustomMarker "+d),n=n||{};var a=c.createHash(d);angular.isDefined(n[a])&&(n[a].show=!1)})},this.hideMarker=function(d){a.all(s).then(function(){b.debug("CesiumjsWidgetService: hideMarker "+d),m=m||{};var a=c.createHash(d);angular.isDefined(m[a])&&(m[a].show=!1)})},this.moveCustomMarker=function(d,e,f,g){a.all(s).then(function(){b.debug("CesiumjsWidgetService: moveCustomMarker "+d),n=n||{};var a=c.createHash(d);angular.isDefined(n[a])&&(n[a].position=Cesium.Cartesian3.fromDegrees(f,e,g))})},this.removeAllMarkers=function(){a.all(s).then(function(){b.debug("CesiumjsWidgetService: removeAllMarkers "+l.length),l.length>0&&l.removeAll(),m={}})},this.removeAllPolyLines=function(){a.all(s).then(function(){b.debug("CesiumjsWidgetService: removeAllPolyLines "+o.length),o.length>0&&o.removeAll(),q={}})},this.removeMarker=function(d){b.debug("CesiumjsWidgetService: removeMarker deferring "+d),a.all(s).then(function(){b.debug("CesiumjsWidgetService: removeMarker "+d),m=m||{};var a=c.createHash(d);angular.isDefined(m[a])&&(l.remove(m[a]),delete m[a])})},this.removePolyLine=function(b){a.all(s).then(function(){o.remove(q[b]),delete q[b]})},this.setActiveLayer=function(a){this.whenReady(function(){if(angular.isDefined(p[a])){p[a].alpha=1,g.imageryLayers.raiseToTop(p[a]);for(var c=1;c<g.imageryLayers;c++)g.imageryLayers.get(c).alpha=0}else b.error("CesiumjsWidgetService: setActiveProvider failed "+a+" does not exist")})},this.setCameraPosition=function(c,d,e,f){a.all(s).then(function(){f?j.flyTo({destination:Cesium.Cartesian3.fromDegrees(d,c,e)}):j.setPositionCartographic(Cesium.Cartographic.fromDegrees(d,c,e))},function(a){b.error("CesiumjsWidgetService: setCameraPosition Failed:"),(a||angular.noop)()},function(a){b.warn("CesiumjsWidgetService: setCameraPosition update: "+a)})},this._setCameraPosition=function(a,b,c,d){angular.isDefined(j)&&(d?j.flyTo({destination:Cesium.Cartesian3.fromDegrees(b,a,c)}):j.setPositionCartographic(Cesium.Cartographic.fromDegrees(b,a,c)))},this.setFullScreen=function(c){a.all(s).then(function(){c?(b.debug("CesiumjsWidgetService: setFullScreen mode: "+!!c),Cesium.Fullscreen.requestFullscreen(g.canvas)):Cesium.Fullscreen.exitFullscreen()})},this.setSceneMode=function(c,d){a.all(s).then(function(){switch(b.debug("CesiumjsWidgetService: Screen mode setting to: "+c),d=null===d?!0:!!d,c){case Cesium.SceneMode.SCENE3D:g.morphTo3D();break;case Cesium.SceneMode.SCENE2D:if(g.scene3DOnly)return void b.error('CesiumjsWidgetService: "3D mode only" was set. Cannot change to a 2D mode');g.morphTo2D();break;case Cesium.SceneMode.COLUMBUS_VIEW:if(g.scene3DOnly)return void b.error('CesiumjsWidgetService: "3D mode only" was set. Cannot change to a 2D mode');g.morphToColumbusView();break;default:return void b.error("CesiumjsWidgetService: invalid Screen mode set")}d||g.completeMorph()})},this.showAllMarkers=function(){a.all(s).then(function(){b.debug("CesiumjsWidgetService: shpowAllMarkers "),m=m||{},angular.forEach(m,function(a){a.show=!0})})},this.showCustomMarker=function(d){a.all(s).then(function(){b.debug("CesiumjsWidgetService: hideMarker "+d),n=n||{};var a=c.createHash(d);angular.isDefined(n[a])&&(n[a].show=!0)})},this.showMarker=function(d){a.all(s).then(function(){b.debug("CesiumjsWidgetService: hideMarker "+d),m=m||{};var a=c.createHash(d);angular.isDefined(m[a])&&(m[a].show=!0)})},this.tick=function(){g.initializeFrame(),angular.isFunction(t.animationMethod)&&t.animationMethod(Cesium.JulianDate.toDate(h.currentTime)),g.render(),Cesium.requestAnimationFrame(t.tick)},this.whenReady=function(c){return b.debug("CesiumjsWidgetService: whenReady"),angular.isFunction(c)&&a.all(s).then(c),a.all(s).promise}}]).directive("cesiumWidget",["$log",function(a){return{restrict:"EA",controller:"WidgetController",scope:{},replace:!1,link:function(b,c,d,e){return angular.isDefined(c[0])&&""!==c[0].id?void e.init(c):void a.error("cesiumWidget: An ID must exist for Cesium to initialize")}}}]);