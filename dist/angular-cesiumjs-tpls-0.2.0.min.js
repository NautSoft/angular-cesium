/*
 * angular-cesiumjs
 * http://maikuru.github.io/angular-cesiumjs

 * Version: 0.2.0 - 2014-11-13
 * License: Apache-2.0
 */
"use strict";angular.module("cesiumjs",["cesiumjs.widget"]).constant("IMAGERY_PROVIDER",{BING:{label:"bing",customLabel:"bing",url:"http://dev.virtualearth.net",ellipsoid:Cesium.Ellipsoid.WGS84,apiKey:null,active:!0,online:!0},BLACK_MARBLE:{label:"blackMarble",customLabel:"blackMarble",url:"http://dev.virtualearth.net",ellipsoid:Cesium.Ellipsoid.WGS84,maximumLevel:8,active:!0,online:!0},NATURAL_EARTH_II:{label:"naturalEarthII",customLabel:"naturalEarthII",url:"bower_components/cesiumjs/Build/Cesium/Assets/Textures/NaturalEarthII",ellipsoid:Cesium.Ellipsoid.WGS84,active:!0,online:!1},WORLDSAT_EARTH:{label:"SeattleMoF",customLabel:"SeattleMoF",url:"http://localhost:8080/geoserver/Seattle.MoF/wms",ellipsoid:Cesium.Ellipsoid.WGS84,active:!0,online:!1}}).constant("SCENE_MODE",{scene2d:Cesium.SceneMode.SCENE2D,scene3d:Cesium.SceneMode.SCENE3D,sceneColumbus:Cesium.SceneMode.COLUMBUS_VIEW}).constant("PIN_COLLECTION_MAKI",{camera:"camera"}),angular.module("cesiumjs.widget",["angular-md5"]).controller("WidgetController",["$scope","$attrs","$parse","$log","CesiumjsWidgetService",function(a,b,c,d,e){this.init=function(a){d.info("WidgetController: init");try{this.$element=a;var c=this.$element[0].id,f={scene3DOnly:"true"===b.scene3dOnly.toLowerCase()||"1"===b.scene3dOnly};e.initViewer(c,f)}catch(g){d.info("WidgetController: failed to initialize"),d.error("WidgetController: "+g.message)}}}]).service("CesiumjsWidgetService",["$q","$log","md5","IMAGERY_PROVIDER","PIN_COLLECTION_MAKI",function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s=a.defer(),t=[s.promise],u=this,v=Cesium.Math;this.animationMethod=null,this.addCustomMarker=function(d,e,f,g,h,i,j){a.all(t).then(function(){b.info("CesiumjsWidgetService: addCustomMarker "+e+" ["+g+","+h+"]");var a=c.createHash(d);p=p||{},f=angular.isNumber(f)&&f>5?f:128,p[a]=n.add({image:e,verticalOrigin:Cesium.VerticalOrigin.CENTER,horizontalOrigin:Cesium.HorizontalOrigin.CENTER,position:Cesium.Cartesian3.fromDegrees(h,g,i),show:!!j})})},this.addMarker=function(d,f,g,h,i,j,k){a.all(t).then(function(){b.info("CesiumjsWidgetService: addMarker "+f+" ["+i+","+j+"]"),o=o||{},angular.isDefined(e[f])||b.error("CesiumjsWidgetService: addMarker - invalid marker type = "+f),h=angular.isNumber(h)&&h>5?h:48;var a=Cesium.Color.fromCssColorString(g),l=c.createHash(d);Cesium.when(m.fromMakiIconId(f,a,h),function(a){b.info("CesiumjsWidgetService: addMarker canvas created"),o[l]=n.add({image:a,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,position:Cesium.Cartesian3.fromDegrees(j,i,0),show:!!k})})})},this.addPolyLine=function(c,d,e,f){a.all(t).then(function(){b.info("CesiumjsWidgetService: addPolyLine"),r=r||{},f&&q.removeAll(),r[c]=q.add({positions:Cesium.Cartesian3.fromDegreesArrayHeights(d),width:2,material:Cesium.Material.fromType("Color",{color:Cesium.Color.fromCssColorString(e)})})})},this.adjustCamera=function(b,c){a.all(t).then(function(){var a=v.toRadians(c);switch(b){case"roll":case"twistRight":l.twistRight(a);break;case"lookUp":case"tilt":l.lookUp(a);break;default:angular.isFunction(l[b])&&l[b](a)}})},this._adjustCamera=function(a,b){if(angular.isDefined(l)){var c=v.toRadians(b);switch(a){case"roll":case"twistRight":l.twistRight(c);break;case"lookUp":case"tilt":l.lookUp(c);break;default:angular.isFunction(l[a])&&l[a](c)}}},this.adjustClock=function(c){a.all(t).then(function(){b.info("CesiumjsWidgetService: adjusting Clock"),b.debug(c),c=angular.isObject(c)?c:{},angular.isDate(c.startTime)&&(j.startTime=Cesium.JulianDate.fromDate(c.startTime)),angular.isDate(c.currentTime)&&(j.currentTime=Cesium.JulianDate.fromDate(c.currentTime)),angular.isDate(c.stopTime)&&(j.stopTime=Cesium.JulianDate.fromDate(c.stopTime)),angular.isNumber(c.multiplier)&&(j.multiplier=c.multiplier),angular.isDefined(Cesium.ClockStep[c.clockStep])&&(j.clockStep=c.clockStep),angular.isDefined(Cesium.ClockRange[c.clockRange])&&(j.clockRange=clockRange)})},this.enableDebug=function(c){a.all(t).then(function(){b.info("CesiumjsWidgetService: enableDebug "+c),i.debugShowFramesPerSecond=!!c})},this.enableDefaultHandlers=function(c){a.all(t).then(function(){b.info("CesiumjsWidgetService: enableDefaultHandlers "+c),c=!!c,i.screenSpaceCameraController.enableLook=c,i.screenSpaceCameraController.enableTilt=c,i.screenSpaceCameraController.enableZoom=c,i.screenSpaceCameraController.enableRotate=c,i.screenSpaceCameraController.enableTranslate=c})},this.enableMoon=function(c){a.all(t).then(function(){b.info("CesiumjsWidgetService: enableMoon "+c),h.scene.moon.show=!!c})},this.enableSkyBox=function(c){a.all(t).then(function(){b.info("CesiumjsWidgetService: enableSkyBox "+c),h.scene.skyAtmosphere.show=!!c})},this.enableSun=function(c){a.all(t).then(function(){b.info("CesiumjsWidgetService: enableSun "+c),h.scene.sun.show=!!c})},this.generateImageryProvider=function(a){switch(b.info("CesiumjsWidgetService: generateImageryProvider "+a.label),b.debug(a),f=f||{},a.label){case d.BING.label:var c=a.apiKey||Cesium.BingMapsApi.defaultKey;Cesium.BingMapsApi.defaultKey=c,f[a.customLabel]=new Cesium.BingMapsImageryProvider({url:a.url,key:c,mapStyle:Cesium.BingMapsStyle.AERIAL});break;case d.BLACK_MARBLE.label:f[a.customLabel]=new Cesium.TileMapServiceImageryProvider({url:a.url,maximumLevel:a.maximumLevel});break;case d.NATURAL_EARTH_II.label:f[a.customLabel]=new Cesium.TileMapServiceImageryProvider({url:a.url});break;case d.WORLDSAT_EARTH.label:b.warn("WORLDSAT not yet implemented");break;default:b.error("no supported image provider:"+a.label)}g||this.setActiveProvider(a.customLabel)},this.generateSkyBox=function(){b.info("CesiumjsWidgetService: generateSkyBox"),b.error("CesiumjsWidgetService: generateSkyBox Error: Should not use this.  Custom SkyBox is not refreshing so sun smears");var a="bower_components/cesiumjs/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80";return new Cesium.SkyBox({positiveX:a+"_px.jpg",negativeX:a+"_mx.jpg",positiveY:a+"_py.jpg",negativeY:a+"_my.jpg",positiveZ:a+"_pz.jpg",negativeZ:a+"_mz.jpg"})},this.getCurrentTime=function(){var b=a.defer();return a.all(t).then(function(){b.resolve(Cesium.JulianDate.toDate(j.currentTime))},function(a){b.reject(a)},function(a){b.update(a)}),b.promise},this.hideAllCustomMarkers=function(){a.all(t).then(function(){b.info("CesiumjsWidgetService: hideAllMarkers "),p=p||{},angular.forEach(p,function(a){a.show=!1})})},this.hideAllMarkers=function(){a.all(t).then(function(){b.info("CesiumjsWidgetService: hideAllMarkers "),o=o||{},angular.forEach(o,function(a){a.show=!1})})},this.hideCustomMarker=function(d){a.all(t).then(function(){b.info("CesiumjsWidgetService: hideCustomMarker "+d),p=p||{};var a=c.createHash(d);angular.isDefined(p[a])&&(p[a].show=!1)})},this.hideMarker=function(d){a.all(t).then(function(){b.info("CesiumjsWidgetService: hideMarker "+d),o=o||{};var a=c.createHash(d);angular.isDefined(o[a])&&(o[a].show=!1)})},this.initViewer=function(a,c){try{if(b.info("CesiumjsWidgetService: initViewer started"),!angular.isDefined(h)||h.isDestroyed()){b.info("CesiumjsWidgetService: initViewer creating widget"),h=new Cesium.CesiumWidget(a,c),h.targetFrameRate=60,h.resolutionScale=2,i=h.scene,j=h.clock,l=i.camera,k=i.primitives,q=k.add(new Cesium.PolylineCollection),n=k.add(new Cesium.BillboardCollection),m=new Cesium.PinBuilder,i.sun=new Cesium.Sun,i.moon=new Cesium.Moon,i.skyAtmosphere=new Cesium.SkyAtmosphere;var d=f[g],e=d.ellipsoid||Cesium.Ellipsoid.WGS84,o=new Cesium.Globe(e);o.imageryLayers.addImageryProvider(d),o.enableLighting=!0,o.showWaterEffect=!1,k.globe=o}else angular.isDefined(h)&&b.warn("CesiumjsWidgetService: initViewer already exists");s.resolve(function(){b.info("CesiumjsWidgetService: init Viewer success")})}catch(p){s.reject(function(){b.info("CesiumjsWidgetService: init Viewer failed"),b.error("CesiumjsWidgetService: "+p.message)})}},this.moveCustomMarker=function(d,e,f,g){a.all(t).then(function(){b.info("CesiumjsWidgetService: moveCustomMarker "+d),p=p||{};var a=c.createHash(d);angular.isDefined(p[a])&&(p[a].position=Cesium.Cartesian3.fromDegrees(f,e,g))})},this.removeAllMarkers=function(){a.all(t).then(function(){b.info("CesiumjsWidgetService: removeAllMarkers "+n.length),n.length>0&&n.removeAll(),o={}})},this.removeAllPolyLines=function(){a.all(t).then(function(){b.info("CesiumjsWidgetService: removeAllPolyLines "+q.length),q.length>0&&q.removeAll(),r={}})},this.removeMarker=function(d){b.info("CesiumjsWidgetService: removeMarker deferring "+d),a.all(t).then(function(){b.info("CesiumjsWidgetService: removeMarker "+d),o=o||{};var a=c.createHash(d);angular.isDefined(o[a])&&(n.remove(o[a]),delete o[a])})},this.removePolyLine=function(b){a.all(t).then(function(){q.remove(r[b]),delete r[b]})},this.setActiveProvider=function(a){b.info("CesiumjsWidgetService: setActiveProvider: "+a),angular.isDefined(f[a])?g=a:b.error("CesiumjsWidgetService: setActiveProvider failed "+a+"does not exist")},this.setCameraPosition=function(c,d,e,f){a.all(t).then(function(){f?l.flyTo({destination:Cesium.Cartesian3.fromDegrees(d,c,e)}):l.setPositionCartographic(Cesium.Cartographic.fromDegrees(d,c,e))},function(a){b.error("CesiumjsWidgetService: setCameraPosition Failed:"),(a||angular.noop)()},function(a){b.warn("CesiumjsWidgetService: setCameraPosition update: "+a)})},this._setCameraPosition=function(a,b,c,d){angular.isDefined(l)&&(d?l.flyTo({destination:Cesium.Cartesian3.fromDegrees(b,a,c)}):l.setPositionCartographic(Cesium.Cartographic.fromDegrees(b,a,c)))},this.setFullScreen=function(c){a.all(t).then(function(){c?(b.info("CesiumjsWidgetService: setFullScreen mode: "+!!c),Cesium.Fullscreen.requestFullscreen(i.canvas)):Cesium.Fullscreen.exitFullscreen()})},this.setSceneMode=function(c,d){a.all(t).then(function(){switch(b.info("CesiumjsWidgetService: Screen mode setting to: "+c),d=null===d?!0:!!d,c){case Cesium.SceneMode.SCENE3D:i.morphTo3D();break;case Cesium.SceneMode.SCENE2D:if(i.scene3DOnly)return void b.error('CesiumjsWidgetService: "3D mode only" was set. Cannot change to a 2D mode');i.morphTo2D();break;case Cesium.SceneMode.COLUMBUS_VIEW:if(i.scene3DOnly)return void b.error('CesiumjsWidgetService: "3D mode only" was set. Cannot change to a 2D mode');i.morphToColumbusView();break;default:return void b.error("CesiumjsWidgetService: invalid Screen mode set")}d||i.completeMorph()})},this.showAllMarkers=function(){a.all(t).then(function(){b.info("CesiumjsWidgetService: shpowAllMarkers "),o=o||{},angular.forEach(o,function(a){a.show=!0})})},this.showCustomMarker=function(d){a.all(t).then(function(){b.info("CesiumjsWidgetService: hideMarker "+d),p=p||{};var a=c.createHash(d);angular.isDefined(p[a])&&(p[a].show=!0)})},this.showMarker=function(d){a.all(t).then(function(){b.info("CesiumjsWidgetService: hideMarker "+d),o=o||{};var a=c.createHash(d);angular.isDefined(o[a])&&(o[a].show=!0)})},this.tick=function(){i.initializeFrame(),angular.isFunction(u.animationMethod)&&u.animationMethod(Cesium.JulianDate.toDate(j.currentTime)),i.render(),Cesium.requestAnimationFrame(u.tick)},this.whenReady=function(c){return b.info("CesiumjsWidgetService: whenReady"),angular.isFunction(c)&&a.all(t).then(c),a.all(t).promise}}]).directive("cesiumWidget",["$log",function(a){return{restrict:"EA",controller:"WidgetController",scope:{},replace:!1,link:function(b,c,d,e){return angular.isDefined(c[0])&&""!==c[0].id?void e.init(c):void a.error("cesiumWidget: An ID must exist for Cesium to initialize")}}}]);